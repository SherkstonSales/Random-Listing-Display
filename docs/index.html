<!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <title>Sherkston Listings Display</title>

  <style>
    body {
      font-family: system-ui, Arial;
      margin: 20px;
      background: #f6f6f6;
    }

    button {
      font-size: 16px;
      padding: 10px 14px;
      margin: 6px 6px 6px 0;
      cursor: pointer;
    }

    input {
      font-size: 16px;
      padding: 8px;
      width: 90px;
    }

    #status {
      margin-top: 12px;
      padding: 10px;
      background: #111;
      color: #fff;
      display: inline-block;
      border-radius: 8px;
    }

    #queue {
      margin-top: 14px;
      padding: 12px;
      border: 1px solid #ccc;
      border-radius: 10px;
      max-width: 1100px;
      background: #fff;
    }

    #queue div {
      margin-top: 6px;
    }

    #queue a {
      color: #0066cc;
      text-decoration: none;
      word-break: break-all;
    }

    #queue a:hover {
      text-decoration: underline;
    }

    #countdown {
      margin-top: 10px;
      font-size: 16px;
    }

    #small {
      opacity: .75;
      margin-top: 14px;
      max-width: 900px;
    }
  </style>
</head>

<body>

<h2>Sherkston Listing Display (Controller)</h2>

<div>
  Rotate every
  <input id="sec" type="number" min="5" value="25" />
  seconds
</div>

<div style="margin-top:10px">
  <button id="start">Start Display Window</button>
  <button id="pause">Pause</button>
  <button id="next">Next</button>
  <button id="shuffle">Shuffle</button>
  <button id="reopen">Re-open Display Window</button>
  <button onclick="window.location.href='custom.html'">Open Custom Display</button>
</div>

<div id="status">Loading listings…</div>

<div id="countdown">
  Next in: <strong><span id="countdownValue">--</span></strong>
</div>

<div id="queue">
  <div>
    <strong>Previous Viewed:</strong>
    <a href="#" id="prevItem">—</a>
  </div>
  <div>
    <strong>Current Viewing:</strong>
    <span id="currItem">—</span>
  </div>
  <div>
    <strong>Next Up:</strong>
    <a href="#" id="nextItem">—</a>
  </div>
</div>

<div id="small">
  Notes:
  <ul>
    <li>Allow popups once so the display window can open.</li>
    <li>Keyboard: Space = Pause / Play · → = Next · R = Shuffle</li>
  </ul>
</div>

<script>
/* ------------------ STATE ------------------ */
let listings = [];
let order = [];
let idx = 0;
let paused = false;
let timer = null;
let countdownTimer = null;
let nextAt = 0;
let displayWin = null;

/* ------------------ ELEMENTS ------------------ */
const statusEl = document.getElementById('status');
const secEl = document.getElementById('sec');
const countdownValueEl = document.getElementById('countdownValue');

const prevItemEl = document.getElementById('prevItem');
const currItemEl = document.getElementById('currItem');
const nextItemEl = document.getElementById('nextItem');

/* ------------------ HELPERS ------------------ */
function shuffle(arr) {
  const a = arr.slice();
  for (let i = a.length - 1; i > 0; i--) {
    const j = Math.floor(Math.random() * (i + 1));
    [a[i], a[j]] = [a[j], a[i]];
  }
  return a;
}

function openOrFocusDisplayWindow() {
  if (displayWin && !displayWin.closed) {
    displayWin.focus();
    return true;
  }
  displayWin = window.open('about:blank', 'SherkstonListingDisplay');
  if (!displayWin) return false;
  displayWin.document.write('<title>Listing Display</title><body>Loading…</body>');
  displayWin.focus();
  return true;
}

/* ------------------ QUEUE DISPLAY ------------------ */
function updateQueue() {
  if (!order.length) return;

  const prevIdx = (idx - 1 + order.length) % order.length;
  const nextIdx = (idx + 1) % order.length;

  prevItemEl.textContent = order[prevIdx];
  currItemEl.textContent = order[idx];
  nextItemEl.textContent = order[nextIdx];

  prevItemEl.onclick = (e) => {
    e.preventDefault();
    idx = prevIdx;
    show();
    startTimer();
  };

  nextItemEl.onclick = (e) => {
    e.preventDefault();
    idx = nextIdx;
    show();
    startTimer();
  };
}

/* ------------------ DISPLAY ------------------ */
function show() {
  if (!order.length) return;

  const url = order[idx];

  if (!openOrFocusDisplayWindow()) {
    statusEl.textContent = 'Popup blocked. Allow popups and try again.';
    return;
  }

  displayWin.location.href = url;

  statusEl.textContent =
    (paused ? 'Paused' : 'Playing') +
    ` | ${idx + 1}/${order.length} | ${url}`;

  updateQueue();
}

function next() {
  if (!order.length) return;
  idx = (idx + 1) % order.length;
  show();
}

/* ------------------ TIMERS ------------------ */
function startTimer() {
  const seconds = Math.max(5, parseInt(secEl.value || '25', 10));

  clearInterval(timer);
  clearInterval(countdownTimer);

  nextAt = Date.now() + seconds * 1000;

  timer = setInterval(() => {
    if (paused) return;
    next();
    nextAt = Date.now() + seconds * 1000;
  }, seconds * 1000);

  countdownTimer = setInterval(() => {
    if (paused) {
      countdownValueEl.textContent = 'PAUSED';
      return;
    }
    const remaining = Math.max(0, Math.ceil((nextAt - Date.now())
