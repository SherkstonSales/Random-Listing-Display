<!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <title>Sherkston Listings Display</title>
  <style>
    body{font-family:system-ui,Arial;margin:20px}
    button{font-size:16px;padding:10px 14px;margin:6px 6px 6px 0;cursor:pointer}
    #status{margin-top:12px;padding:10px;background:#111;color:#fff;display:inline-block;border-radius:8px}
    #small{opacity:.75;margin-top:10px;max-width:900px}
    input{font-size:16px;padding:8px;width:90px}
  </style>
</head>
<body>
  <h2>Sherkston Listing Display (Actual Website Pages)</h2>

  <div>
    Rotate every
    <input id="sec" type="number" min="5" value="25" />
    seconds
  </div>

  <div style="margin-top:10px">
    <button id="start">Start Display Window</button>
    <button id="pause">Pause</button>
    <button id="next">Next</button>
    <button id="shuffle">Shuffle</button>
    <button id="reopen">Re-open Display Window</button>
    <button onclick="window.location.href='custom.html'">Open Custom Display</button>
  </div>

  <div id="status">Loading listings…</div>
  <div id="countdown" style="margin-top:10px;font-size:16px;">
    Next in: <strong><span id="countdownValue">--</span></strong>s
  </div>

  <div id="queue" style="margin-top:12px; padding:10px; border:1px solid #ddd; border-radius:10px; max-width:1000px;">
    <div>
      <strong>Previous Viewed:</strong>
      <a href="#" id="prevItem" style="margin-left:6px;"></a>
    </div>
    <div style="margin-top:6px;">
      <strong>Current Viewing:</strong>
      <span id="currItem">—</span>
    </div>
    <div style="margin-top:6px;">
      <strong>Next Up:</strong>
      <a href="#" id="nextItem" style="margin-left:6px;"></a>
    </div>
  </div>

  <div id="small">
    Notes:
    <ul>
      <li>You must allow popups for this site (one-time) or the display window can’t open.</li>
      <li>This shows the real SunOutdoors listing pages (full page), not an embedded frame.</li>
      <li>Keyboard: Space = Pause/Play, → = Next, R = Shuffle</li>
    </ul>
  </div>

<script>
let listings = [];
let order = [];
let idx = 0;
let paused = false;
let timer = null;
let displayWin = null;

let nextAt = 0;
let countdownTimer = null;

const countdownValueEl = document.getElementById('countdownValue');

const statusEl = document.getElementById('status');
const secEl = document.getElementById('sec');

const prevItemEl = document.getElementById('prevItem');
const currItemEl = document.getElementById('currItem');
const nextItemEl = document.getElementById('nextItem');

function shuffle(arr){
  const a = arr.slice();
  for(let i=a.length-1;i>0;i--){
    const j = Math.floor(Math.random()*(i+1));
    [a[i],a[j]] = [a[j],a[i]];
  }
  return a;
}

// Optional: make the queue text nicer than a full URL
function shortLabel(url){
  try {
    const u = new URL(url);
    // keep host + last path segment (usually enough)
    const last = u.pathname.split('/').filter(Boolean).pop() || u.hostname;
    return `${u.hostname}/${last}`;
  } catch {
    return url;
  }
}

function updateQueue(){
  if (!order.length) return;

  const prevIdx = (idx - 1 + order.length) % order.length;
  const nextIdx = (idx + 1) % order.length;

  const prevUrl = order[prevIdx];
  const currUrl = order[idx];
  const nextUrl = order[nextIdx];

  // Text
  prevItemEl.textContent = shortLabel(prevUrl);
  currItemEl.textContent = shortLabel(currUrl);
  nextItemEl.textContent = shortLabel(nextUrl);

  // Hrefs (so they're real links)
  prevItemEl.href = prevUrl;
  nextItemEl.href = nextUrl;

  // Wire clicks to jump (keep your popup display behavior)
  prevItemEl.onclick = (e) => {
    e.preventDefault();
    idx = prevIdx;
    show();
    startTimer();
  };

  nextItemEl.onclick = (e) => {
    e.preventDefault();
    idx = nextIdx;
    show();
    startTimer();
  };
}

function openOrFocusDisplayWindow(){
  // Try to reuse existing window
  if (displayWin && !displayWin.closed) {
    displayWin.focus();
    return true;
  }
  // Open a blank window we control, then we navigate it
  displayWin = window.open('about:blank', 'SherkstonListingDisplay');
  if (!displayWin) return false;
  displayWin.document.write('<title>Listings Display</title><body style="font-family:system-ui;margin:20px">Loading…</body>');
  displayWin.focus();
  return true;
}

function show(){
  if (!order.length) return;

  const url = order[idx];

  // Update the queue display every time we show something
  updateQueue();

  if (!openOrFocusDisplayWindow()){
    statusEl.textContent = 'Popup blocked. Allow popups for this site, then click "Re-open Display Window".';
    return;
  }

  // Navigate the display window to the real listing page (cross-origin navigation is allowed)
  displayWin.location.href = url;

  statusEl.textContent =
    (paused ? 'Paused' : 'Playing') +
    ` | ${idx+1}/${order.length} | ` + url;
}

function next(){
  if (!order.length) return;
  idx = (idx + 1) % order.length;
  show();
}

function startTimer(){
  const seconds = Math.max(5, parseInt(secEl.value || '25', 10));
  clearInterval(timer);
  clearInterval(countdownTimer);

  // set the "next change" time
  nextAt = Date.now() + seconds * 1000;

  // main rotation timer
  timer = setInterval(() => {
    if (paused) return;
    next();
    nextAt = Date.now() + seconds * 1000;
  }, seconds * 1000);

  // countdown updater (smooth display)
  countdownTimer = setInterval(() => {
    const remainingMs = Math.max(0, nextAt - Date.now());
    const remainingSec = Math.ceil(remainingMs / 1000);
    countdownValueEl.textContent = paused ? 'PAUSED' : String(remainingSec);
  }, 200);
}

document.getElementById('start').addEventListener('click', () => {
  paused = false;
  document.getElementById('pause').textContent = 'Pause';
  openOrFocusDisplayWindow();
  show();
  startTimer();
});

document.getElementById('reopen').addEventListener('click', () => {
  openOrFocusDisplayWindow();
  show();
});

document.getElementById('pause').addEventListener('click', () => {
  paused = !paused;
  document.getElementById('pause').textContent = paused ? 'Play' : 'Pause';

  // When unpausing, restart the countdown fr
